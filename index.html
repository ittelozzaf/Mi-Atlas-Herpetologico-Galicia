<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="./resources/ol.css">
<link rel="stylesheet" href="resources/fontawesome-all.min.css">
<link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
<link rel="stylesheet" href="./resources/ol-layerswitcher.css">
<link rel="stylesheet" href="./resources/qgis2web.css">

<style>
html, body { background-color: #ffffff; margin:0; padding:0; }
#map { width:100%; height:100%; margin:0; padding:0; }

.ol-zoom,.ol-rotate,.ol-attribution button { display:none !important; }

.search-container {
  position:absolute;
  top:15px;
  left:10px;
  z-index:1000;
  display:flex;
  gap:5px;
  background:white;
  padding:6px 10px;
  border-radius:4px;
  box-shadow:0 1px 4px rgba(0,0,0,0.3);
  font-family:'Quicksand', sans-serif;
  font-size:13px;
}

.search-container input {
  padding:4px 6px;
  font-size:13px;
  width:160px;
  font-family:'Quicksand', sans-serif;
  font-weight:400;
  letter-spacing:0.2px;
}

.autocomplete{position:relative;display:flex;flex-direction:column;}
.dropdown{
  position:absolute;
  top:100%;
  left:0;
  right:0;
  background:white;
  border:1px solid #ccc;
  border-radius:4px;
  margin-top:4px;
  max-height:260px;
  overflow-y:auto;
  box-shadow:0 2px 8px rgba(0,0,0,0.25);
  display:none;
  z-index:2000;
  font-family:'Quicksand',sans-serif;
}
.dropdown div{padding:6px 8px;cursor:pointer;font-size:13px;line-height:1.35;}
.dropdown div:hover{background:#f0f0f0;}

.ol-popup {
  position:absolute;
  background-color:rgba(255,255,255,0.96);
  padding:14px 18px;
  border-radius:6px;
  border:1px solid #ccc;
  min-width:260px;
  max-width:420px;
  font-family:'Quicksand', sans-serif;
  line-height:1.65;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  opacity:0;
  transition:opacity .25s ease-in-out;
}
.ol-popup.visible { opacity:1; }
.ol-popup:after,.ol-popup:before { display:none; }

.ol-popup-closer {
  position:absolute;
  top:4px;
  right:6px;
  font-size:15px;
  color:#666;
  text-decoration:none;
}
</style>

<title>Mi Atlas Herpetológico de Galicia</title>
</head>
<body>

<div class="search-container">

  <div class="autocomplete">
    <input id="speciesSelect" placeholder="Buscar especie..." autocomplete="off">
    <div id="speciesDropdown" class="dropdown"></div>
  </div>

  <div class="autocomplete">
    <input id="gridSelect" placeholder="Buscar cuadrícula..." autocomplete="off">
    <div id="gridDropdown" class="dropdown"></div>
  </div>

</div>

<div id="map">
<div id="popup" class="ol-popup">
<a href="#" id="popup-closer" class="ol-popup-closer"></a>
<div id="popup-content"></div>
</div>
</div>

<script src="resources/qgis2web_expressions.js"></script>
<script src="./resources/functions.js"></script>
<script src="./resources/ol.js"></script>
<script src="./resources/ol-layerswitcher.js"></script>
<script src="resources/photon-geocoder-autocomplete.min.js"></script>
<script src="layers/Comunidade_Autonoma_IGN_1.js"></script>
<script src="layers/10x10_atlasatlas_10x10_2.js"></script>
<script src="styles/Comunidade_Autonoma_IGN_1_style.js"></script>
<script src="styles/10x10_atlasatlas_10x10_2_style.js"></script>
<script src="./layers/layers.js" type="text/javascript"></script>
<script src="./resources/Autolinker.min.js"></script>
<script src="./resources/qgis2web.js"></script>

<script>
window.addEventListener('load', function(){

    const view = map.getView();

    // Guardar posición y zoom inicial
    const initialCenter = view.getCenter().slice(); 
    const initialZoom = view.getZoom();

    let atlasLayer = null;
    map.getLayers().forEach(function(l){
        const t=(l.get('title')||'').toLowerCase();
        if(t.includes('atlas')) atlasLayer=l;
    });
    if(!atlasLayer) return;

    // --- BLOQUEAR COMPLETAMENTE LA VISTA ---
    map.getInteractions().forEach(function(interaction){
        if(!(interaction instanceof ol.interaction.Select)){
            map.removeInteraction(interaction);
        }
    });

    view.setMinZoom(initialZoom);
    view.setMaxZoom(initialZoom);

    const speciesInput=document.getElementById('speciesSelect');
    const gridInput=document.getElementById('gridSelect');
    const speciesDropdown=document.getElementById('speciesDropdown');
    const gridDropdown=document.getElementById('gridDropdown');

    const features=atlasLayer.getSource().getFeatures();

    const speciesArray=[...new Set(features.flatMap(f=>(f.get('especies')||'').split(';').map(s=>s.trim()).filter(Boolean)))].sort();
    const gridArray=[...new Set(features.map(f=>f.get('CUADRICULA')).filter(Boolean))].sort();

    function filterFeatures(){
        const sTxt=speciesInput.value.toLowerCase();
        const gTxt=gridInput.value.toLowerCase();
        features.forEach(f=>{
            const especies=(f.get('especies')||'').toLowerCase();
            const cuad=(f.get('CUADRICULA')||'').toLowerCase();
            const visible=(sTxt===''||especies.includes(sTxt))&&(gTxt===''||cuad.includes(gTxt));
            f.setStyle(visible?undefined:new ol.style.Style(null));
        });
    }

    function setupAutocomplete(input,dropdown,data){
        input.addEventListener('input',()=>{
            const val=input.value.toLowerCase();
            dropdown.innerHTML='';
            if(!val){dropdown.style.display='none';filterFeatures();return;}
            const matches=data.filter(v=>v.toLowerCase().includes(val)).slice(0,10);
            matches.forEach(m=>{
                const div=document.createElement('div');
                div.textContent=m;
                div.onclick=()=>{input.value=m;dropdown.style.display='none';filterFeatures();};
                dropdown.appendChild(div);
            });
            dropdown.style.display=matches.length?'block':'none';
            filterFeatures();
        });
        document.addEventListener('click',e=>{if(!input.contains(e.target))dropdown.style.display='none';});
    }

    setupAutocomplete(speciesInput,speciesDropdown,speciesArray);
    setupAutocomplete(gridInput,gridDropdown,gridArray);

    const overlay=new ol.Overlay({element:document.getElementById('popup'),autoPan:false});
    map.addOverlay(overlay);

    const popupEl=document.getElementById('popup');

    // Función de cierre del popup (cierra y anima el mapa)
    function closePopup() {
        popupEl.classList.remove('visible'); 
        overlay.setPosition(undefined); 
        view.animate({
            center: initialCenter,
            zoom: initialZoom,
            duration: 800
        });
    }

    document.getElementById('popup-closer').onclick = function(){
        closePopup();
        return false;
    };

    // Cerrar popup al hacer clic fuera del mismo
    map.on('click', function(evt){
        // Si el clic no está sobre el overlay, cerrar
        const clickedPixel = evt.pixel;
        const overlayPixel = map.getPixelFromCoordinate(overlay.getPosition() || [0,0]);
        if(overlay.getPosition() && clickedPixel[0] < overlayPixel[0]-popupEl.offsetWidth ||
           clickedPixel[0] > overlayPixel[0]+popupEl.offsetWidth ||
           clickedPixel[1] < overlayPixel[1]-popupEl.offsetHeight ||
           clickedPixel[1] > overlayPixel[1]+popupEl.offsetHeight){
            closePopup();
        }
    });

    map.on('singleclick', function(evt){
        let foundFeature=null;
        map.forEachFeatureAtPixel(evt.pixel,function(ft,layer){
            if(layer!==atlasLayer) return;
            if(!ft.get('CUADRICULA')) return;
            foundFeature=ft; 
            return true;
        });
        if(!foundFeature) return;

        // Cerrar popup anterior si existe
        closePopup();

        const especies=(foundFeature.get('especies')||'').split(';').map(s=>'<i>'+s.trim()+'</i>').join(', ');
        document.getElementById('popup-content').innerHTML=
            '<b>Cuadrícula:</b> '+foundFeature.get('CUADRICULA')+'<br>'+
            '<b>Nº especies:</b> '+foundFeature.get('n_especies')+'<br>'+
            '<b>Especies:</b> '+especies;

        overlay.setPosition(evt.coordinate);

        setTimeout(() => {
            const margin = 10;
            const rect = popupEl.getBoundingClientRect();
            let pixel = map.getPixelFromCoordinate(overlay.getPosition());
            let dx = 0, dy = 0;

            if(rect.right > window.innerWidth - margin) dx = rect.right - window.innerWidth + margin;
            if(rect.left < margin) dx = rect.left - margin;
            if(rect.bottom > window.innerHeight - margin) dy = rect.bottom - window.innerHeight + margin;
            if(rect.top < margin) dy = rect.top - margin;

            if(dx || dy){
                overlay.setPosition(map.getCoordinateFromPixel([
                    pixel[0] - dx,
                    pixel[1] - dy
                ]));
            }

            popupEl.classList.add('visible');
        }, 0);
    });
});
</script>

</body>
</html>
