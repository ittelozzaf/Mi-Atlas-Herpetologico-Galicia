<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="./resources/ol.css">
<link rel="stylesheet" href="resources/fontawesome-all.min.css">
<link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
<link rel="stylesheet" href="./resources/ol-layerswitcher.css">
<link rel="stylesheet" href="./resources/qgis2web.css">

<style>
html, body { background-color: #ffffff; margin:0; padding:0; }
#map { width:100%; height:100%; margin:0; padding:0; }

.ol-zoom,
.ol-rotate,
.ol-attribution button { display:none !important; }

.search-container {
  position:absolute;
  top:15px;
  left:10px;
  z-index:1000;
  display:flex;
  gap:5px;
  background:white;
  padding:6px 10px;
  border-radius:4px;
  box-shadow:0 1px 4px rgba(0,0,0,0.3);
  font-family:'Quicksand', sans-serif;
  font-size:13px;
}

.search-container input {
  padding:4px 6px;
  font-size:13px;
  width:160px;
  font-family:'Quicksand', sans-serif;
  font-weight:400;
  letter-spacing:0.2px;
}

.ol-popup {
  position:absolute;
  background-color:rgba(255,255,255,0.96);
  padding:14px 18px;
  border-radius:6px;
  border:1px solid #ccc;
  min-width:260px;
  max-width:420px;
  font-family:'Quicksand', sans-serif;
  line-height:1.65;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  opacity:0;
  transition:opacity .25s ease-in-out;
}

.ol-popup.visible { opacity:1; }
.ol-popup:after,.ol-popup:before { display:none; }

.ol-popup-closer {
  position:absolute;
  top:4px;
  right:6px;
  font-size:15px;
  color:#666;
  text-decoration:none;
}
</style>

<title>Mi Atlas Herpetológico de Galicia</title>
</head>
<body>

<div class="search-container">
  <input id="speciesSelect" placeholder="Buscar especie..." list="speciesList">
  <datalist id="speciesList"></datalist>
  <input id="gridSelect" placeholder="Buscar cuadrícula..." list="gridList">
  <datalist id="gridList"></datalist>
</div>

<div id="map">
<div id="popup" class="ol-popup">
<a href="#" id="popup-closer" class="ol-popup-closer"></a>
<div id="popup-content"></div>
</div>
</div>

<script src="resources/qgis2web_expressions.js"></script>
<script src="./resources/functions.js"></script>
<script src="./resources/ol.js"></script>
<script src="./resources/ol-layerswitcher.js"></script>
<script src="resources/photon-geocoder-autocomplete.min.js"></script>
<script src="layers/Comunidade_Autonoma_IGN_1.js"></script>
<script src="layers/10x10_atlasatlas_10x10_2.js"></script>
<script src="styles/Comunidade_Autonoma_IGN_1_style.js"></script>
<script src="styles/10x10_atlasatlas_10x10_2_style.js"></script>
<script src="./layers/layers.js" type="text/javascript"></script>
<script src="./resources/Autolinker.min.js"></script>
<script src="./resources/qgis2web.js"></script>

<script>
window.addEventListener('load', function(){

    let atlasLayer=null;
    let ignLayer=null;

    map.getLayers().forEach(function(l){
        const t=(l.get('title')||'').toLowerCase();
        if(t.includes('atlas')) atlasLayer=l;
        if(t.includes('ign')) ignLayer=l;
    });

    if(!atlasLayer) return;

    if(ignLayer) ignLayer.set('interactive',false);

    map.getInteractions().forEach(function(i){
        if(i instanceof ol.interaction.MouseWheelZoom ||
           i instanceof ol.interaction.DoubleClickZoom ||
           i instanceof ol.interaction.PinchZoom ||
           i instanceof ol.interaction.KeyboardZoom ||
           i instanceof ol.interaction.DragPan){
            map.removeInteraction(i);
        }
    });

    const view=map.getView();
    const zoom=view.getZoom();
    view.setMinZoom(zoom);
    view.setMaxZoom(zoom);

    const speciesInput=document.getElementById('speciesSelect');
    const gridInput=document.getElementById('gridSelect');

    const features=atlasLayer.getSource().getFeatures();

    const speciesSet=new Set();
    const gridSet=new Set();

    features.forEach(f=>{
        const val=f.get('especies');
        if(val) val.split(';').forEach(s=>speciesSet.add(s.trim()));
        const cuad=f.get('CUADRICULA');
        if(cuad) gridSet.add(cuad);
    });

    const speciesList=document.getElementById('speciesList');
    [...speciesSet].sort().forEach(sp=>{
        const opt=document.createElement('option');
        opt.value=sp;
        speciesList.appendChild(opt);
    });

    const gridList=document.getElementById('gridList');
    [...gridSet].sort().forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c;
        gridList.appendChild(opt);
    });

    function filterFeatures(){
        const sTxt=speciesInput.value.toLowerCase();
        const gTxt=gridInput.value.toLowerCase();

        features.forEach(f=>{
            const especies=(f.get('especies')||'').toLowerCase();
            const cuad=(f.get('CUADRICULA')||'').toLowerCase();
            const visible=(sTxt===''||especies.includes(sTxt))&&(gTxt===''||cuad.includes(gTxt));
            f.setStyle(visible?undefined:new ol.style.Style(null));
        });
    }

    speciesInput.addEventListener('input',filterFeatures);
    gridInput.addEventListener('input',filterFeatures);

    const overlay=new ol.Overlay({
        element:document.getElementById('popup'),
        autoPan:false
    });
    map.addOverlay(overlay);

    const popupEl=document.getElementById('popup');

    document.getElementById('popup-closer').onclick=function(){
        popupEl.classList.remove('visible');
        overlay.setPosition(undefined);
        return false;
    };

    map.on('singleclick',function(evt){

        let foundFeature=null;

        map.forEachFeatureAtPixel(evt.pixel,function(ft,layer){
            if(layer!==atlasLayer) return;
            if(!ft.get('CUADRICULA')) return;
            foundFeature=ft;
            return true;
        });

        if(!foundFeature) return;

        const especies=(foundFeature.get('especies')||'')
            .split(';')
            .map(s=>'<i>'+s.trim()+'</i>')
            .join(', ');

        const html=
            '<b>Cuadrícula:</b> '+foundFeature.get('CUADRICULA')+'<br>'+
            '<b>Nº especies:</b> '+foundFeature.get('n_especies')+'<br>'+
            '<b>Especies:</b> '+especies;

        document.getElementById('popup-content').innerHTML=html;

        overlay.setPosition(evt.coordinate);
        popupEl.classList.remove('visible');
        setTimeout(()=>popupEl.classList.add('visible'),10);
    });
});
</script>

</body>
</html>
